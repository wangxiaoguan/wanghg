<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>SocketIo</title>
    <script src="socket.io.js"></script>
    <style>
        html,body,#box{      width:100%;
            height:100%;
        }
        #box{
            position: absolute;
            background: rgba(0,0,0,0.7);
            top:0;
            left:0;
           
        }
        .inner{
            width:300px;
            height:180px;
            border:2px solid dodgerblue;
            border-radius: 10%;
            position: absolute;
            z-index:10;
            top:0;
            left:0;
            right:0;
            bottom:0;
            margin:auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            
        }
        #op{
            font-size:28px;
            color:orange;
        }
        #inp{
            display:none;
        }
        #count{
            color:darkblue;
            font-size:36px;
        }
    </style>
</head>
<body>
    <h1>聊天室-SocketIo </h1>
    <h2>  实时在线人数 -----  <b id="count"> 0 </b>  </h2>
    <div id="chatroom"
        style="width:360px;height: 420px;border:2px solid darkorange;font-size:20px;overflow: auto;"
    >

    </div>
    <input type="text" placeholder="请输入聊天内容" id="sayInput">
    <input type="button" value="发送" id="btn" >

    <div id="box">
        <div class="inner">
            <p id="op"> connect to server ... </p>
            <div id="inp">
                <input type="text" placeholder="请输入昵称" id="nickname" required>
                <button id="loginbtn">登录聊天室</button>
            </div>
        </div>
    </div>


    <script>
    //    客户端   client 
    // 1. 监听 server 是否开启
    // 2. 监听 server 发来的消息
    // 3. 监听 server  error
    // 4. 监听 server close
        var  socketIo = null;
        // var nickname = null;
        function $$id(id){
            return document.getElementById(id);
        }
        window.onload = function(){

            socketIo = io.connect("http://127.0.0.1:5500");  // 连接 服务端 socket 
            // socketIo = io.connect("60.205.201.113:5000"); 
            // 1. 监听 server 是否开启
            socketIo.on("connect",()=>{
                console.log("来自客户端的连接....")
                $$id("inp").style.display = "block";
                $$id("op").innerHTML = "connect successful!"
            })
            
            loginbtn.onclick = function(){
                socketIo.emit("login",nickname.value) // 发送事件 服务器接收
            }

            socketIo.on("loginSuccess",()=>{
                $$id("box").style.display = "none";
                $$id("inp").style.display = "none";
                $$id("op").innerHTML = "connect to server ..."

            })

            socketIo.on("setUserCount",count=>{
                $$id("count").innerHTML = count;
            })
            
            // 展示聊天记录 
            function displayMsg(msg,color){
                $$id("chatroom").innerHTML += `<p  style='color:${color}'>${msg}</p>`
            }

            socketIo.on("system",value=>{
                displayMsg(`${value} 上线了...`,'red');
            })

            socketIo.on("sendMsg",(nickname,msg)=>{
                displayMsg(`${nickname} 说 : ${msg}`,'#000');
            })
            function send(){
                socketIo.emit("message",sayInput.value);
               
                sayInput.value = ""
            }

            $$id("btn").onclick = send;

            document.onkeyup = function(e){
                console.log(e.keyCode);
                if(e.keyCode == 13){
                    send()
                }
            }

            // 监听 服务器 socket 关闭 
            socketIo.on("disconnect",()=>{
                console.log("服务端 socket 失去响应 ...")
            })
        }
    </script>
</body>
</html>