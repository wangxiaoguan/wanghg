<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>数据</title>
    <style>
        *{padding: 0;margin: 0;list-style: none;}
        .search{text-align: center;margin:10px 0;}
       #content{width: 760px;overflow: hidden;margin:0 auto;}
       #content li{float:left; width: 180px;height:200px;margin:5px;font-size:8px;}
       #content li img{width:180px;height:180px;;}
       .page{width:100px;height: 20px;margin:5px auto;color:red;}
    </style>
</head>
<body>
<span id="loginurl">未登录</span>　　　　　　　　
<span id="mygoodscar"></span>
<div class="search">
    <input id="text" placeholder="搜索"><button id="search">查找</button>
    <input type="radio" value="goodsprice" name="radio" checked>价格
    <input type="radio" value="goodsname" name="radio">商品名
    <button id="ascend">升序</button>
    <button id="descend">降序</button><br/><br/>
    <button id="prev">上一页</button>
    <select id="selectnum">
        <option value="8">每页显示8行数据</option>
        <option value="12">每页显示12行数据</option>
        <option value="16">每页显示16行数据</option>
    </select>
    <button id="next">下一页</button>
</div>

<ul id="content">
   
</ul>
<div class="page">◇第<span id="page" style="color:purple"></span>页◇</div>
</body>
<script src="js/ajax.js"></script>
<script src="js/cookie.js"></script>
<script>
    var page=document.getElementById("page");//显示第几页

    var content=document.getElementById("content");
    var textinput=document.getElementById("text");
    var search=document.getElementById("search");
    var radiolist=document.getElementsByName("radio");
    var ascend=document.getElementById("ascend");
    var descend=document.getElementById("descend");
    var prev=document.getElementById("prev");
    var next=document.getElementById("next");
    var selectnum=document.getElementById("selectnum");

    var mygoodscar=document.getElementById("mygoodscar");
    var loginurl=document.getElementById("loginurl"); 
    loginurl.innerHTML=getCookie("loginUserName")||`<a href="index.html">未登录</a>`;
    if(getCookie("loginUserName")){
        mygoodscar.innerHTML=`<a href="goodscar.html">我的购物车</a>`;
    }

    //公共样式
    var key="";
    var order="goodsid";
    var desc="asc";
    var pagenum=0;
    var datanum=8;

    page.innerHTML=pagenum+1;

    getData(key,order,desc,pagenum,datanum);
    selectnum.onchange= function () {
    datanum=this.value;
    pagenum=0;
    page.innerHTML=pagenum+1;
    getData(key,order,desc,pagenum,datanum);
}

search.onclick= function () {
        key=textinput.value;    
        pagenum=0;
        page.innerHTML=pagenum+1;
        getData(key,order,desc,pagenum,datanum);
    };

for(var i=0;i<radiolist.length;i++){
    radiolist[i].onclick= function () {
        order=this.value;
        // pagenum=0;
        // key=textinput.value;
        page.innerHTML=pagenum+1;
        getData(key,order,desc,pagenum,datanum);
    }
}
ascend.onclick= function () {
        desc="asc";
        pagenum=0;
        page.innerHTML=pagenum+1;
        getData(key,order,desc,pagenum,datanum);
    };
descend.onclick= function () {
        desc="desc";
        pagenum=0;
        page.innerHTML=pagenum+1;
        getData(key,order,desc,pagenum,datanum);
    };

    function getData(key,order,desc,pagenum,datanum){
        $.ajax({
            type:"get",
            url:"php/shoppingcar.php",
            data:{
                key:key,
                order:order,
                desc:desc,
                pagenum:pagenum,
                datanum:datanum
            },
            dataType:"json",
            fn:function (sum) {
                var list=sum;
                var html="";
                for(var i=0;i<list.length;i++){
                    var item=list[i];
                    var goodsid=item["goodsid"];
                    var goodsname=item["goodsname"];
                    var goodsprice=item["goodsprice"];
                    var goodsnum=item["goodsnum"];
                    var goodsimg=item["goodsimg"];
                   
                    html+=`<li>
                            <img src="images/${goodsimg}.jpg">                           
                            <span>名称:${goodsname}</span>
                            <span>价格:${goodsprice}</span>
                            <span>数量:${goodsnum}</span>
                            <button onclick="buy('${goodsid}','${goodsname}','${goodsprice}','${goodsimg}')">购买</button>
                         </li>`;
                }
                content.innerHTML=html;
                $.ajax({
                    type:"get",
                    url:"php/goodscount.php",
                    data:{key:key},
                    dataType:"json",
                    fn:function (obj) {
                        var count=obj["count"];
                        var pagemax=Math.ceil(count/datanum-1);
                        prev.disabled=false;
                        prev.onclick= function () {
                            pagenum--;
                            page.innerHTML=pagenum+1;
                            getData(key,order,desc,pagenum,datanum);            
                        };
                        next.disabled = false;
                        next.onclick= function () {
                            pagenum++;
                            page.innerHTML=pagenum+1;
                            getData(key,order,desc,pagenum,datanum);                           
                        };
                        if (pagemax == pagenum) { //就表明是最后一页
                            next.disabled = true;
                            next.onclick = null;
                        }
                        if (pagenum == 0) {
                            prev.disabled = true;
                            prev.onclick = null;
                        }

                    }

                })
            }
        })
    }

    function buy(goodsid,goodsname,goodsprice,goodsimg){
        var userid=getCookie("loginUserId");
        if(userid){
            $.ajax({
                type:"get",
                url:"php/shopcar.php",
                data:{userid:userid,
                      goodsid:goodsid,
                      goodsname:goodsname,
                      goodsprice:goodsprice,                    
                      goodsnum:1,
                      goodsimg:goodsimg               
                    },
                dataType:"json",
                fn:function(result){
                        if(result["code"]==1){
                            alert(result.msg);
                            // if(confirm("是否进入购物车")){
                            //     window.location.href="goodscar.html";
                            // }
                        }else{
                            alert(result.msg);
                        }
                } 
            })

        }else{
            setCookie("loginurl",window.location.href,7);
            window.location.href="index.html";
        }
    }
</script>
</html>